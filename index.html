<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ===== FIREBASE ===== */
const app=initializeApp({
  apiKey:"AIzaSyBaVE7ARMQVlX7j9G-X67F46148I0ucBZo",
  databaseURL:"https://mystic-8e71f-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"mystic-8e71f"
});
const db=getDatabase(app);
const stateRef=ref(db,"mysticState");

/* ===== DATA ===== */
const names=[
"LGoHo","GinTonic","Cabernet","SLANE","TheDalmore","Wulinagye",
"AmericanoNoSweet","Asahi","GoldLabel","MadamREDRUM","21stHIBIKI",
"Highball","BlueLaBel","HalesBlueBoy","เสือฝ้าย","CaramelMacchiato",
"17thHIBIKI","B52","GREENLABEL","IRONBALLS"
];

let queue=1,locked=false,scale=1,booked=[];
const members=[],dots=document.getElementById("dots");

/* ===== MEMBERS ===== */
names.forEach((n,i)=>{
  const d=document.createElement("div");
  d.className="member";
  d.textContent=`${i+1}. ${n}`;
  memberList.appendChild(d);
  members.push(d);
});

/* ===== POPUP ===== */
let popupAction=null;
function showPopup(title,text,action=null){
  popupTitle.textContent=title;
  popupText.innerHTML=text;
  popupOverlay.classList.remove("hidden");
  popupAction=action;
}
window.closePopup=()=>{
  popupOverlay.classList.add("hidden");
  if(popupAction){ popupAction(); popupAction=null; }
};

/* ===== RENDER ===== */
function render(){
  dots.innerHTML="";
  members.forEach((m,i)=>{
    m.className="member";
    m.textContent=`${i+1}. ${names[i]}`;
  });

  booked.forEach(p=>{
    const d=document.createElement("div");
    d.className="dot";
    d.textContent=p.q;
    d.style.left=(p.x-14)+"px";
    d.style.top=(p.y-14)+"px";
    dots.appendChild(d);
    members[p.q-1].classList.add("reserved");
  });

  if(!locked) members[queue-1]?.classList.add("active");

  statusBar.textContent = locked
    ? "SYSTEM LOCKED — ALL RESERVED"
    : "Current Queue: " + queue;
}

/* ===== SYNC ===== */
onValue(stateRef,s=>{
  const v=s.val(); if(!v)return;
  queue=v.queue; locked=v.locked; booked=v.booked||[];
  render();
});

/* ===== MAP CLICK ===== */
mapWrapper.onclick=e=>{
  if(e.target.id!=="map")return;

  if(locked){
    showPopup(
      "SYSTEM LOCKED",
      "All reservation slots have been completed.<br>No further reservations are allowed."
    );
    return;
  }

  const r=map.getBoundingClientRect();
  const x=Math.floor((e.clientX-r.left)/scale);
  const y=Math.floor((e.clientY-r.top)/scale);

  if(booked.some(p=>Math.hypot(p.x-x,p.y-y)<28)){
    showPopup(
      "INVALID SPOT",
      "This spot has already been reserved.<br>Please select another location."
    );
    return;
  }

  const name = names[queue-1];
  showPopup(
    "CONFIRM RESERVATION",
    `Do you want to reserve this spot for <b>${name}</b>?`,
    ()=>{
      booked.push({x,y,q:queue});

      if(queue===names.length){
        locked=true;
        showPopup(
          "RESERVATION COMPLETE",
          "The final reservation has been completed.<br>The system is now locked."
        );
      }else{
        queue++;
      }

      set(stateRef,{queue,locked,booked});
    }
  );
};

/* ===== ADMIN AUTH ===== */
function adminAuth(action){
  showPopup(
    "ADMIN ACCESS",
    `Enter admin password:<br><br>
     <input id="pw" type="password"
       style="width:90%;padding:6px;background:#000;border:1px solid #0ff;color:#0ff">`,
    ()=>{
      const pw=document.getElementById("pw").value;
      if(pw!=="7890"){
        showPopup("ACCESS DENIED","Incorrect password.");
        return;
      }
      action();
    }
  );
}

/* ===== UNDO ===== */
window.adminUndo=()=>{
  adminAuth(()=>{
    if(!booked.length){
      showPopup("UNDO","No reservation to undo.");
      return;
    }
    booked.pop();
    queue=Math.max(queue-1,1);
    locked=false;
    set(stateRef,{queue,locked,booked});
  });
};

/* ===== RESET ===== */
window.adminReset=()=>{
  adminAuth(()=>{
    set(stateRef,{queue:1,locked:false,booked:[]});
  });
};
</script>
