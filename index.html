<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const app=initializeApp({
  apiKey:"AIzaSyBaVE7ARMQVlX7j9G-X67F46148I0ucBZo",
  databaseURL:"https://mystic-8e71f-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"mystic-8e71f"
});
const db=getDatabase(app);
const stateRef=ref(db,"mysticState");

const names=[
"LGoHo","GinTonic","Cabernet","SLANE","TheDalmore","Wulinagye",
"AmericanoNoSweet","Asahi","GoldLabel","MadamREDRUM","21stHIBIKI",
"Highball","BlueLaBel","HalesBlueBoy","à¹€à¸ªà¸·à¸­à¸à¹‰à¸²à¸¢","CaramelMacchiato",
"17thHIBIKI","B52","GREENLABEL","IRONBALLS"
];

let queue=1,locked=false,scale=1,booked=[];
const members=[],dots=document.getElementById("dots");
const list=document.getElementById("memberList");

names.forEach((n,i)=>{
  const d=document.createElement("div");
  d.className="member";
  d.textContent=`${i+1}. ${n}`;
  list.appendChild(d);
  members.push(d);
});

function render(){
  dots.innerHTML="";
  members.forEach((m,i)=>{
    m.classList.remove("active","reserved");
    m.textContent=`${i+1}. ${names[i]}`;
  });

  booked.forEach(p=>{
    drawDot(p.x,p.y,p.q);
    members[p.q-1].classList.add("reserved");
    members[p.q-1].textContent=`${p.q}. ${names[p.q-1]} â€” RESERVED`;
  });

  if(!locked && members[queue-1]) members[queue-1].classList.add("active");
  statusBar.textContent=locked?"ALL RESERVED â€” LOCKED":`Current Queue: ${queue}`;
}

onValue(stateRef,s=>{
  const v=s.val(); if(!v)return;
  queue=v.queue; locked=v.locked; booked=v.booked||[];
  render();
});

/* ===== FIXED CONFIRM FLOW ===== */
mapWrapper.onclick=e=>{
  if(locked){tronAlert("âŒ Reservation closed");return;}
  if(e.target.id!=="map")return;

  const currentName=names[queue-1];

  tronConfirm(`${currentName} , Do you want to reserve this spot?`,yes=>{
    if(!yes) return;

    const r=map.getBoundingClientRect();
    const x=Math.floor((e.clientX-r.left)/scale);
    const y=Math.floor((e.clientY-r.top)/scale);

    if(booked.some(p=>Math.hypot(p.x-x,p.y-y)<28)){
      tronAlert("âŒ Spot already taken");
      return;
    }

    booked.push({x,y,q:queue});

    if(queue===names.length){
      locked=true;
      tronAlert("ðŸŽ‰ Final reservation completed. System locked.");
    }else{
      queue++;
    }

    set(stateRef,{queue,locked,booked});
  });
};

function drawDot(x,y,q){
  const d=document.createElement("div");
  d.className="dot";
  d.textContent=q;
  d.style.left=(x-14)+"px";
  d.style.top=(y-14)+"px";
  dots.appendChild(d);
}

/* ===== CONTROLS (à¹€à¸”à¸´à¸¡ à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸”à¹‰à¸„à¸£à¸š) ===== */
window.zoomIn=()=>{scale=Math.min(scale+.1,3);mapWrapper.style.transform=`scale(${scale})`;}
window.zoomOut=()=>{scale=Math.max(scale-.1,.5);mapWrapper.style.transform=`scale(${scale})`;}
window.resetZoom=()=>{scale=1;mapWrapper.style.transform="scale(1)";}
window.toggleList=()=>document.querySelector(".left").classList.toggle("hide");

window.adminUndo=()=>{
  if(prompt("Password")!=="7890")return;
  if(!booked.length)return;
  booked.pop(); queue=Math.max(queue-1,1); locked=false;
  set(stateRef,{queue,locked,booked});
};
window.adminReset=()=>{
  if(prompt("Password")!=="7890")return;
  set(stateRef,{queue:1,locked:false,booked:[]});
};
</script>
